<!-- This file has been auto-generated! -->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>WPA2 Key Generation Vulnerability: Linksys / D-Link</title>
        <!-- Style -->
        <link rel="stylesheet" href="../../css/code.css">
        <link rel="stylesheet" href="../../css/markdown.css">
        <style>
            body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
            }

            header {
                position: relative;
            }
            header > .links {
                position: absolute;
                right: 0;
            }

            .post-key {
                background-color: hsl(45, 67%, 80%);
                border-radius: 5px 0px 0px 5px;
                padding: 2px 6px 2px 8px;
                margin: 0px;
            }
            .post-val {
                background-color: hsl(45, 67%, 90%);
                border-radius: 0px 5px 5px 0px;
                padding: 2px 8px 2px 6px;
                margin: 0px;
            }

            footer {
                text-align: center;
            }
        
            @media (max-width: 767px) {
                body {
                    padding: 15px;
                }
            }
        </style>
    </head>
    <body class="markdown-body">
        <header>
            <div class="links">
                <span>
                    <a href="https://twitter.com/AlexAltea">Twitter</a> |
                    <a href="https://github.com/AlexAltea">Github</a> |
                    <a href="mailto:alexandro@phi.nz">Email</a>
                </span>
            </div>
            <span><a href="../../">&lt; Other articles</a></span>
        </header>
        <article>
            <h1>WPA2 Key Generation Vulnerability: Linksys / D-Link</h1>
            <p>
                <span 
                    class="post-key">Author</span><span
                    class="post-val">Alexandro Sanchez</span>
                <span
                    class="post-key">Date</span><span
                    class="post-val">2013-03-31</span>
            </p>
            <p>After finding the <a href="../2013-03-08-wpa2-vulnerability-tplink/">TP-Link WPA2 Key Generation Vulnerability</a>, I reverse-engineered assistants provided by other vendors. It turns out that some Linksys and D-Link routers user nearly identical algorithms to generate the default WPA2 keys as TP-Link routers use. For more information about this vulnerability and its consequences, please refer to the report linked above as redundant information will be omitted here.</p>
<p>This time, the vulnerability affects the <strong>Linksys EasyLink Advisor</strong> and <strong>D-Link Quick Setup Wizard</strong> assistants, both based in <em>Network Magic</em>, a software created by Pure Networks, a company belonging to Cisco/Linksys. Since Pure Networks actually sold their software to third parties, e.g. D-Link, there might be a chance of other affected assistants.</p>
<p>The reversed generator is:</p>
<div class="codehilite"><pre><span></span><span class="n">blacklist_windows</span> <span class="o">=</span> <span class="s2">&quot;1I2Z0O5SUV&quot;</span>
<span class="n">blacklist_macosx</span>  <span class="o">=</span> <span class="s2">&quot;B8DO0I1S5UVZ2&quot;</span>
<span class="n">blacklist</span> <span class="o">=</span> <span class="n">blacklist_windows</span>  <span class="c1"># Change me</span>

<span class="k">def</span> <span class="nf">gen</span><span class="p">(</span><span class="n">seed</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">seed</span> <span class="o">=</span> <span class="p">((</span><span class="n">seed</span> <span class="o">*</span> <span class="mh">0x343FD</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x269EC3</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">)</span>
            <span class="n">edx</span> <span class="o">=</span> <span class="p">((</span><span class="n">seed</span> <span class="o">&gt;&gt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">)</span> <span class="o">%</span> <span class="mh">0x24</span>
            <span class="k">if</span> <span class="n">edx</span> <span class="o">&gt;=</span> <span class="mh">0xA</span><span class="p">:</span>
                <span class="n">edx</span> <span class="o">+=</span> <span class="mh">0x37</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edx</span> <span class="o">+=</span> <span class="mh">0x30</span>
            <span class="k">if</span> <span class="nb">chr</span><span class="p">(</span><span class="n">edx</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">edx</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">return</span> <span class="n">key</span>
</pre></div>


<p>The seeds used by this function are obtained in the exactly same way as in the TP-Link assistant. The only difference this time is that rather than pseudorandomly choosing characters from a <em>whitelist</em>, it adds random characters in range <code>[0-9A-Z]</code>, filtering out those found in a hardcoded <em>blacklist</em>, meant to prevent adding visually similar characters such as '<code>0</code>' and '<code>O</code>' to the key.</p>
<p>As explained in the TP-Link vulnerability report, the low entropy can be exploited to bruteforce the key in a matter of minutes with a powerful GPU or hours with a CPU.</p>
<h2 id="affected-routers">Affected routers</h2>
<p>The complete list of affected Linksys routers is:</p>
<ul>
<li>WAP610N (Blacklisted characters on Windows assistant: <code>"1I2Z0O5SUVB8"</code>)</li>
<li>WRT110</li>
<li>WRT120N</li>
<li>WRT160N (V1, V2, V3)</li>
<li>WRT160N-HP (V1*)</li>
<li>WRT160NL</li>
<li>WRT310N (V1, V2)</li>
<li>WRT320N</li>
<li>WRT400N</li>
<li>WRT54G2</li>
<li>WRT610N (V1*, V2)</li>
</ul>
<p>The complete list of affected D-Link routers is:</p>
<ul>
<li>DGL-4100</li>
<li>DGL-4300</li>
<li>DIR-615 (not all revisions)</li>
<li>DIR-625</li>
<li>DIR-635</li>
<li>WBR-1310</li>
<li>WBR-1310 Rev. B</li>
<li>WBR-2310</li>
</ul>
<h2 id="resources">Resources</h2>
<ul>
<li><strong>Linksys-CheckKeys</strong>: Check if your key is vulnarable to this attack, i.e., find whether your key is in the set of keys generated by all possible seeds. Download: <a href="http://www.mediafire.com/download.php?pmqt9aykwxhwkto">http://www.mediafire.com/download.php?pmqt9aykwxhwkto</a>.</li>
<li><strong>Linksys-GenSeeds</strong>: This tool calculates the seed interval from the given time interval in which the router might have been installed. Download: <a href="http://www.mediafire.com/download.php?kpe7844kqd9bk4j">http://www.mediafire.com/download.php?kpe7844kqd9bk4j</a>.</li>
<li><strong>Linksys-GenKeys</strong>: Generate a key dictionary by specifying a seed interval. Download: <a href="http://www.mediafire.com/download.php?2h9y0pkay9id1rt">http://www.mediafire.com/download.php?2h9y0pkay9id1rt</a>.</li>
</ul>
<h2 id="solutions">Solutions</h2>
<ul>
<li>Do not use seeds at all. Feed the results of a cryptographically secure PRNG such as <code>/dev/urandom</code> in Unix-like sytems as indices of the character array modulo its length. This is for instance what the Linksys E4200 WLAN routers do, the indices of the key character array are provided by <code>CryptGenRandom</code> in <code>Advapi32.dll</code>.</li>
<li>If for some reason you want to use seeds for generating keys:</li>
<li>Make them bigger than 32-bit. Just 2^32 keys are easy to check.</li>
<li>Obtain them from a cryptographically secure PRNG.</li>
<li>If you still want to obtain them from the system time, use low granularity time intervals (e.g. elapsed time in nanoseconds rather than seconds) to minimize the number of bits an attacker can guess. </li>
</ul>
        </article>
        <hr>
        <footer>
            <p>
                Questions? Comments? <a href="https://github.com/AlexAltea/blog/issues">Open an issue!</a>
            </p>
            <p><a href="mailto:alexandro@phi.nz">alexandro@phi.nz</a></p>
        </footer>
    </body>
</html>

<!-- This file has been auto-generated! -->
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Solutions of xchg rax,rax</title>
        <!-- Style -->
        <link rel="stylesheet" href="../../css/code.css">
        <link rel="stylesheet" href="../../css/markdown.css">
        <style>
            body {
                box-sizing: border-box;
                min-width: 200px;
                max-width: 980px;
                margin: 0 auto;
                padding: 45px;
            }

            header {
                position: relative;
            }
            header > .links {
                position: absolute;
                right: 0;
            }

            .post-key {
                background-color: hsl(45, 67%, 80%);
                border-radius: 5px 0px 0px 5px;
                padding: 2px 6px 2px 8px;
                margin: 0px;
            }
            .post-val {
                background-color: hsl(45, 67%, 90%);
                border-radius: 0px 5px 5px 0px;
                padding: 2px 8px 2px 6px;
                margin: 0px;
            }

            footer {
                text-align: center;
            }
        
            @media (max-width: 767px) {
                body {
                    padding: 15px;
                }
            }
        </style>
    </head>
    <body class="markdown-body">
        <header>
            <div class="links">
                <span>
                    <a href="https://twitter.com/AlexAltea">Twitter</a> |
                    <a href="https://github.com/AlexAltea">Github</a> |
                    <a href="mailto:alexandro@phi.nz">Email</a>
                </span>
            </div>
            <span><a href="../../">&lt; Other articles</a></span>
        </header>
        <article>
            <h1>Solutions of xchg rax,rax</h1>
            <p>
                <span 
                    class="post-key">Author</span><span
                    class="post-val">Alexandro Sanchez</span>
                <span
                    class="post-key">Date</span><span
                    class="post-val">2016-10-12</span>
            </p>
            <h2 id="introduction">Introduction</h2>
<p>In words of <em>xorpd</em>, the author of <code>xchg rax,rax</code>:</p>
<blockquote>
<p><code>xchg rax,rax</code> is a collection of assembly gems and riddles I found over many years of reversing and writing assembly code. The book contains 0x40 short assembly snippets, each built to teach you one concept about assembly, math or life in general.</p>
<p>Be warned - This book is not for beginners. It doesn't contain anything besides assembly code, and therefore some x86_64 assembly knowledge is required.</p>
<p>How to use this book? Get an assembler (Yasm or Nasm is recommended), and obtain the x86_64 instruction set. Then for every snippet, try to understand what it does. Try to run it with different inputs if you don't understand it in the beginning. Look up for instructions you don't fully know in the Instruction sets PDF. Start from the beginning. The order has meaning.</p>
<p>As a final note, the full contents of the book could be viewed for free on my website (Just google "xchg rax,rax").</p>
</blockquote>
<p>The original release, which can be read online at [1], contains no official solutions, and some of the snippets doesn't even seem to yield a clearly defined "answer". Also, in his own words:</p>
<blockquote>
<blockquote>
<p>Is that the content of your book? Some assembly language instructions without comments?</p>
</blockquote>
<p>Yes.</p>
<blockquote>
<p>Is that a bad joke?</p>
</blockquote>
<p>No, arranging almost meaningless sequences of assembler instructions against a black background is a form of <strong>art</strong>. You may call it <em>nerd poetry</em>.</p>
</blockquote>
<p>Nevertheless, I recovered from old backups my own thoughts and solutions for some of the snippets, and uploaded them just in case it could be useful or interesting for someone.</p>
<p>[1] <a href="http://www.xorpd.net/pages/xchg_rax/snip_00.html">http://www.xorpd.net/pages/xchg_rax/snip_00.html</a></p>
<h2 id="solutions">Solutions</h2>
<h3 id="snippet-0x00">Snippet 0x00</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">xor</span>      <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">lea</span>      <span class="no">rbx</span><span class="p">,[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nf">loop</span>     <span class="no">$</span>
    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0</span>
    <span class="nf">and</span>      <span class="no">esi</span><span class="p">,</span><span class="mi">0</span>
    <span class="nf">sub</span>      <span class="no">edi</span><span class="p">,</span><span class="no">edi</span>
    <span class="nf">push</span>     <span class="mi">0</span>
    <span class="nf">pop</span>      <span class="no">rbp</span>
</pre></div>


<p>Different ways of setting several general purpose registers to <em>0</em>.</p>
<h3 id="snippet-0x01">Snippet 0x01</h3>
<div class="codehilite"><pre><span></span><span class="nl">.loop:</span>
    <span class="nf">xadd</span>     <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>Computes the <code>rcx</code>-th term of the Fibonacci sequence, assuming the initial state <code>rax=0</code>, <code>rdx=1</code>.</p>
<h3 id="snippet-0x02">Snippet 0x02</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">neg</span>      <span class="no">rax</span>
    <span class="nf">sbb</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">neg</span>      <span class="no">rax</span>
</pre></div>


<p>Boolean cast: <code>rax := bool(rax)</code>, i.e. <code>rax := rax ? 1 : 0</code>.</p>
<h3 id="snippet-0x03">Snippet 0x03</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">sub</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">sbb</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">and</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
</pre></div>


<p>Minimum function: <code>rax := min(rax, rdx)</code>.</p>
<h3 id="snippet-0x04">Snippet 0x04</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">xor</span>      <span class="no">al</span><span class="p">,</span><span class="mi">0x20</span>
</pre></div>


<p>Replaces uppercase with lowercase characters and viceversa.</p>
<h3 id="snippet-0x05">Snippet 0x05</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">sub</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">5</span>
    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">4</span>
</pre></div>


<p>Allows to branch depending on whether <code>rax</code> is in range <em>[5,9]</em> using only one <code>jbe</code> jump.</p>
<h3 id="snippet-0x06">Snippet 0x06</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">not</span>      <span class="no">rax</span>
    <span class="nf">inc</span>      <span class="no">rax</span>
    <span class="nf">neg</span>      <span class="no">rax</span>
</pre></div>


<p>Does nothing since the instructions cancel each other.</p>
<h3 id="snippet-0x07">Snippet 0x07</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">inc</span>      <span class="no">rax</span>
    <span class="nf">neg</span>      <span class="no">rax</span>
    <span class="nf">inc</span>      <span class="no">rax</span>
    <span class="nf">neg</span>      <span class="no">rax</span>
</pre></div>


<p>Does nothing since the instructions cancel each other.</p>
<h3 id="snippet-0x08">Snippet 0x08</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">rcr</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">1</span>
</pre></div>


<p>Computes the average, i.e. <code>rax := (rax + rdx) / 2</code>.</p>
<p>Note that it prevents overflow issues since <code>rcr</code> does a 33-bit rotation using the <code>CF</code> flag.</p>
<h3 id="snippet-0x09">Snippet 0x09</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">adc</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">0</span>
</pre></div>


<p>Computes <code>rax := (rax + 4) / 8</code>.</p>
<p>Note this is computing <code>rax / 8</code> and rounding to the nearest integer (thanks <a href="https://github.com/ZaneH">@ZaneH</a>).</p>
<h3 id="snippet-0x0a">Snippet 0x0A</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">add</span>      <span class="no">byte</span> <span class="p">[</span><span class="no">rdi</span><span class="p">],</span><span class="mi">1</span>
<span class="nl">.loop:</span>
    <span class="nf">inc</span>      <span class="no">rdi</span>
    <span class="nf">adc</span>      <span class="no">byte</span> <span class="p">[</span><span class="no">rdi</span><span class="p">],</span><span class="mi">0</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>Increments by one an <strong>arbitrarily long</strong> little-endian integer at <code>rdi</code>.</p>
<h3 id="snippet-0x0b">Snippet 0x0B</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">not</span>      <span class="no">rdx</span>
    <span class="nf">neg</span>      <span class="no">rax</span>
    <span class="nf">sbb</span>      <span class="no">rdx</span><span class="p">,-</span><span class="mi">1</span>
</pre></div>


<p>Toggles between not (<code>~</code>) and negation (<code>-</code>) based on the value of <code>rax</code>.</p>
<div class="codehilite"><pre><span></span>if (rax)
  rdx = ~rdx
else
  rdx = -rdx
</pre></div>


<p>Note that <code>rax</code> is also negated as a side-effect.</p>
<h3 id="snippet-0x0c">Snippet 0x0C</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">xor</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">ror</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0xd</span>

    <span class="nf">ror</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">0xd</span>
    <span class="nf">ror</span>      <span class="no">rbx</span><span class="p">,</span><span class="mi">0xd</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>

    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
</pre></div>


<p>Registers <code>rax</code>, <code>rcx</code> end up with the same value, thanks to distributivity of ROR (with XOR).</p>
<div class="codehilite"><pre><span></span>rcx = rax
rcx = (rcx ^ rbx) &gt;&gt; 13
rax = (rax &gt;&gt; 13) ^ (rbx &gt;&gt; 13)
</pre></div>


<h3 id="snippet-0x0d">Snippet 0x0D</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rbx</span>

    <span class="nf">xor</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">and</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">and</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>
</pre></div>


<p>Registers <code>rdx</code>, <code>rbx</code> end up with the same value, thanks to distributivity of AND (with XOR) and commutativity of XOR.</p>
<div class="codehilite"><pre><span></span>rdx = rbx
rbx = (rbx &amp; rax) ^ (rcx &amp; rax)  // Associativity of AND
rax = (rdx &amp; rax) ^ (rcx &amp; rax)  // Commutativity of XOR
</pre></div>


<h3 id="snippet-0x0e">Snippet 0x0E</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">not</span>      <span class="no">rcx</span>

    <span class="nf">not</span>      <span class="no">rax</span>
    <span class="nf">not</span>      <span class="no">rbx</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>

    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
</pre></div>


<p>Registers <code>rax</code>, <code>rcx</code> end up with the same value, thanks to DeMorgan's law.</p>
<div class="codehilite"><pre><span></span>rcx = rax
rcx = ~(rcx &amp; rbx)
rax = ~rax | ~rbx
</pre></div>


<h3 id="snippet-0x0f">Snippet 0x0F</h3>
<div class="codehilite"><pre><span></span><span class="nl">.loop:</span>
    <span class="nf">xor</span>      <span class="no">byte</span> <span class="p">[</span><span class="no">rsi</span><span class="p">],</span><span class="no">al</span>
    <span class="nf">lodsb</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>Computes the following:</p>
<div class="codehilite"><pre><span></span>rsi[0] ^= al
rsi[1] ^= rsi[0]
rsi[2] ^= rsi[1]
rsi[3] ^= rsi[2]
...
</pre></div>


<p>This resembles a 8-bit CBC encryption scheme using <code>al</code> as IV, except for the fact that it uses the identity function as block cipher encryption instead of a pseudorandom function.</p>
<h3 id="snippet-0x10">Snippet 0x10</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">push</span>     <span class="no">rax</span>
    <span class="nf">push</span>     <span class="no">rcx</span>
    <span class="nf">pop</span>      <span class="no">rax</span>
    <span class="nf">pop</span>      <span class="no">rcx</span>

    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">xor</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>

    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">sub</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">neg</span>      <span class="no">rcx</span>

    <span class="nf">xchg</span>     <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
</pre></div>


<p>Different ways of swapping the contents of <code>rax</code> and <code>rcx</code>.</p>
<h3 id="snippet-0x11">Snippet 0x11</h3>
<div class="codehilite"><pre><span></span><span class="nl">.loop:</span>
    <span class="nf">mov</span>      <span class="no">dl</span><span class="p">,</span><span class="no">byte</span> <span class="p">[</span><span class="no">rsi</span><span class="p">]</span>
    <span class="nf">xor</span>      <span class="no">dl</span><span class="p">,</span><span class="no">byte</span> <span class="p">[</span><span class="no">rdi</span><span class="p">]</span>
    <span class="nf">inc</span>      <span class="no">rsi</span>
    <span class="nf">inc</span>      <span class="no">rdi</span>
    <span class="nf">or</span>       <span class="no">al</span><span class="p">,</span><span class="no">dl</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>Compares two buffers <code>rsi</code> and <code>rdi</code> of length <code>rcx</code>. Assuming <code>al</code> is zero-initialized, it will remain as <em>0</em> unless the buffers differ.</p>
<h3 id="snippet-0x12">Snippet 0x12</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">and</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Computes <code>(rax | rdx) + (rax &amp; rdx)</code>, which can be simplified to <code>rax + rdx</code>.</p>
<h3 id="snippet-0x13">Snippet 0x13</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0x40</span>
<span class="nl">.loop:</span>
    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">and</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">shl</span>      <span class="no">rbx</span><span class="p">,</span><span class="mi">0x1</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>Computes <code>rax + rbx</code>.</p>
<p>See also: https://en.wikipedia.org/wiki/Adder_(electronics)</p>
<h3 id="snippet-0x14">Snippet 0x14</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">1</span>

    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
</pre></div>


<p>Computes the average rounded to the lowest integer, i.e. <code>rax := floor((rax + rdx) / 2)</code>.</p>
<h3 id="snippet-0x15">Snippet 0x15</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0xffffffff80000000</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Casts the <code>int32_t</code> value in <code>eax</code> to an <code>int64_t</code> value in <code>rax</code>.</p>
<p>Note that this requires the 32 most significant bits in <code>rax</code> to be cleared.</p>
<h3 id="snippet-0x16">Snippet 0x16</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">xor</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">mov</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">add</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">cmovc</span>    <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rsi</span>
</pre></div>


<p>Computes the following:</p>
<div class="codehilite"><pre><span></span>rsi := (rax ^ rbx) + (rbx ^ rcx)
if (overflew(rsi))
    rax := 0
else
    rax := rax ^ rcx
cmp(rax, rsi)
</pre></div>


<p>Observations:
- If <code>rax</code> == <code>rbx</code>: No overflow.
- If <code>rcx</code> == <code>rbx</code>: No overflow.
- If <code>rax</code> == <code>~rbx</code>: Always overflows, except when <code>rbx</code> == <code>rcx</code>.
- If <code>rbx</code> == <code>rax|rcx</code>: No overflow.
- If <code>rbx</code> == <code>rax&amp;rcx</code>: No overflow.</p>
<p><em>TODO: No idea about this one.</em></p>
<h3 id="snippet-0x17">Snippet 0x17</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">cqo</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">sub</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Computes the absolute value of <code>rax</code>, i.e. <code>rax := abs(rax)</code>.</p>
<h3 id="snippet-0x18">Snippet 0x18</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">rdtsc</span>
    <span class="nf">shl</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x20</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">rdtsc</span>
    <span class="nf">shl</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x20</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">cmp</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
</pre></div>


<p>Compares two consecutively obtained timestamps.</p>
<p>The instruction <code>rdtsc</code> stores the current 64-bit timestamp counter value in <code>edx:eax</code>, while the <code>shl</code> and <code>or</code> instructions aggregate the halves of each register into <code>rax</code>. Trivially, the second timestamp will always be larger than the first one.</p>
<h3 id="snippet-0x19">Snippet 0x19</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">call</span>     <span class="no">.skip</span>
    <span class="nf">db</span>       <span class="err">&#39;</span><span class="no">hello</span> <span class="no">world</span><span class="p">!</span><span class="err">&#39;</span><span class="p">,</span><span class="mi">0</span>
<span class="nl">.skip:</span>
    <span class="nf">call</span>     <span class="no">print_str</span>
    <span class="nf">add</span>      <span class="no">rsp</span><span class="p">,</span><span class="mi">8</span>
</pre></div>


<p>Calls <code>print_str("hello world!");</code>.</p>
<p>The return value of <code>.skip</code> is the address to the hardcoded string, and due to the stack layout, this will implicitly become the first argument of <code>print_str</code>.</p>
<h3 id="snippet-0x1a">Snippet 0x1A</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">call</span>     <span class="no">.next</span>
<span class="nl">.next:</span>
    <span class="nf">pop</span>      <span class="no">rax</span>
</pre></div>


<p>Gets the <code>rip</code> register after the call instruction, i.e. <code>rax := .next</code>.</p>
<h3 id="snippet-0x1b">Snippet 0x1B</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">push</span>     <span class="no">rax</span>
    <span class="nf">ret</span>
</pre></div>


<p>Indirect branch to <code>rax</code>. Since there's no immediate arguments to cause further stack cleanup, this is equivalent to <code>jmp rax</code>.</p>
<h3 id="snippet-0x1c">Snippet 0x1C</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">pop</span>      <span class="no">rsp</span>
</pre></div>


<p>Swaps the stack pointer with the address at the top of the current stack.</p>
<h3 id="snippet-0x1d">Snippet 0x1D</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rsp</span><span class="p">,</span><span class="no">buff2</span> <span class="err">+</span> <span class="no">n</span><span class="p">*</span><span class="mi">8</span> <span class="err">+</span> <span class="mi">8</span>
    <span class="nf">mov</span>      <span class="no">rbp</span><span class="p">,</span><span class="no">buff1</span> <span class="err">+</span> <span class="no">n</span><span class="p">*</span><span class="mi">8</span>
    <span class="nf">enter</span>    <span class="mi">0</span><span class="p">,</span><span class="no">n</span><span class="err">+</span><span class="mi">1</span>
</pre></div>


<p>Copies <code>buff1</code> to <code>buff2</code>. The extra <code>+1</code> and <code>+8</code> take care of the side effects of <code>enter</code>, such as the extra values added before and after the buffer.</p>
<p>Note that the <code>buff2</code> should be 16 bytes larger than <code>buff1</code>, specifically with 8 bytes of padding at the beginning and at the end to prevent OOB writes after executing the <code>enter</code> instruction.</p>
<h3 id="snippet-0x1e">Snippet 0x1E</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">cmp</span>      <span class="no">al</span><span class="p">,</span><span class="mi">0x0a</span>
    <span class="nf">sbb</span>      <span class="no">al</span><span class="p">,</span><span class="mi">0x69</span>
    <span class="nf">das</span>
</pre></div>


<p>Maps each value in range [0x0, 0xF] stored in <code>al</code> into its hexadecimal representation, i.e. [0x30, ..., 0x39, 0x41, ..., 0x46].</p>
<h3 id="snippet-0x1f">Snippet 0x1F</h3>
<div class="codehilite"><pre><span></span><span class="nl">.loop:</span>
    <span class="nf">bsf</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="no">cl</span>
    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">je</span>       <span class="no">.exit_loop</span>
    <span class="nf">lea</span>      <span class="no">rax</span><span class="p">,[</span><span class="no">rax</span> <span class="err">+</span> <span class="mi">2</span><span class="p">*</span><span class="no">rax</span> <span class="err">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nf">jmp</span>      <span class="no">.loop</span>
<span class="nl">.exit_loop:</span>
</pre></div>


<p>Computes the Collatz sequence for any starting number stored in <code>rax</code>.</p>
<p>See also: https://en.wikipedia.org/wiki/Collatz_conjecture</p>
<h3 id="snippet-0x20">Snippet 0x20</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shl</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">2</span>
    <span class="nf">add</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shl</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">add</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shl</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">add</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shl</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">add</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shl</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">add</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
</pre></div>


<p>Computes <code>rcx := 1337 * rax</code>.</p>
<h3 id="snippet-0x21">Snippet 0x21</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">mov</span>      <span class="no">rdi</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">sub</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">add</span>      <span class="no">rdi</span><span class="p">,</span><span class="no">rcx</span>

    <span class="nf">imul</span>     <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">imul</span>     <span class="no">rsi</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">imul</span>     <span class="no">rdi</span><span class="p">,</span><span class="no">rbx</span>

    <span class="nf">add</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">mov</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rsi</span>
    <span class="nf">sub</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdi</span>
</pre></div>


<p>Computes the following after corresponding simplifications:</p>
<div class="codehilite"><pre><span></span>rax := rax * rcx - rbx * rdx
rbx := rax * rdx + rbx * rcx
</pre></div>


<p>This corresponds to the multiplication of two complex numbers:
(a + bi) * (c + di) = (ac - bd) + (ad + bc)i.</p>
<h3 id="snippet-0x22">Snippet 0x22</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0xaaaaaaaaaaaaaaab</span>
    <span class="nf">mul</span>      <span class="no">rdx</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">mov</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Computes <code>rax := rax / 3</code> rounding to the closest integer.</p>
<h3 id="snippet-0x23">Snippet 0x23</h3>
<div class="codehilite"><pre><span></span><span class="nl">.loop:</span>
    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">5</span>
    <span class="nf">jbe</span>      <span class="no">.exit_loop</span>
    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">2</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">jmp</span>      <span class="no">.loop</span>
<span class="nl">.exit_loop:</span>

    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">cmc</span>
    <span class="nf">sbb</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">and</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">sub</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Computes <code>rax := rax % 3</code>.</p>
<h3 id="snippet-0x24">Snippet 0x24</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">mov</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rax</span>
<span class="nl">.loop:</span>
    <span class="nf">mul</span>      <span class="no">rbx</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">sub</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">2</span>
    <span class="nf">neg</span>      <span class="no">rax</span>
    <span class="nf">mul</span>      <span class="no">rsi</span>
    <span class="nf">mov</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">cmp</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">ja</span>       <span class="no">.loop</span>
<span class="nl">.exit_loop:</span>
</pre></div>


<p>Computes <code>rcx := rax % 2</code>.</p>
<h3 id="snippet-0x25">Snippet 0x25</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">xor</span>      <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">shl</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0x20</span>
<span class="nl">.loop:</span>
    <span class="nf">movzx</span>    <span class="no">rbx</span><span class="p">,</span><span class="no">cx</span>
    <span class="nf">imul</span>     <span class="no">rbx</span><span class="p">,</span><span class="no">rbx</span>

    <span class="nf">ror</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0x10</span>
    <span class="nf">movzx</span>    <span class="no">rdx</span><span class="p">,</span><span class="no">cx</span>
    <span class="nf">imul</span>     <span class="no">rdx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">rol</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0x10</span>

    <span class="nf">add</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">shr</span>      <span class="no">rbx</span><span class="p">,</span><span class="mi">0x20</span>
    <span class="nf">cmp</span>      <span class="no">rbx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">adc</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">0</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>Register <code>rax</code> acts as a counter, and <code>rcx</code> loops from 0x100000000 to 0x0. Each iteration will split the <code>ecx</code> values in two 16-bit halves, <em>x</em> and <em>y</em>, and verify the following property:</p>
<div class="codehilite"><pre><span></span>(x*x + y*y) &gt;&gt; 20 == 1
</pre></div>


<p>Since <em>x</em> and <em>y</em> are each 16-bit, <code>x*x + y*y</code> must be in range <em>[0x0, 0x1FFFC0002]</em>, thus <code>(x*x + y*y) &gt;&gt; 20</code> must be either 0 or 1. Therefore, each iteration is actually verifying that: <code>x*x + y*y &gt;= 0x100000000</code>. This is equivalent to <em>x^2 + y^2 &gt;= 0x10000^2</em>.</p>
<p>Since <em>(x,y)</em> iterate each in range <em>[0x0000, 0xFFFF]</em> as <code>rcx</code> decreases. The value stored in <code>rax</code> after the snippet has been executed will be the number of points in <em>[0, 65535]^2</em> lying outside the circumference of radius 65536 centered at the origin.</p>
<p>This ratio of points will be <em>1 - pi/4</em>, yielding an expected value of <code>rax := 0x100000000 * (1 - pi/4)</code>.</p>
<h3 id="snippet-0x26">Snippet 0x26</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">7</span>
    <span class="nf">shl</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x39</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Rotates the value in the <code>rax</code> register 7 bits to the right. Equivalent to <code>ror rax, 7</code>.</p>
<h3 id="snippet-0x27">Snippet 0x27</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">ch</span><span class="p">,</span><span class="no">cl</span>
    <span class="nf">inc</span>      <span class="no">ch</span>
    <span class="nf">shr</span>      <span class="no">ch</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">shr</span>      <span class="no">cl</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="no">cl</span>
    <span class="nf">xchg</span>     <span class="no">ch</span><span class="p">,</span><span class="no">cl</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="no">cl</span>
</pre></div>


<p>This computes: <code>rax := rax &gt;&gt; ((cl &gt;&gt; 1) + ((cl + 1) &gt;&gt; 1))</code> which is equivalent to <code>rax := rax / 2**T(cl)</code>, where <em>T(n) := n(n+1)/2</em> represents the <em>n</em>-th <a href="https://en.wikipedia.org/wiki/Triangular_number">triangular number</a>.</p>
<p>The denominator in the expression above corresponds to the sequence <a href="https://oeis.org/A006125">A006125</a> as <code>cl</code> increases.</p>
<p><em>TODO: Is there anything else special about this snippet?</em></p>
<h3 id="snippet-0x28">Snippet 0x28</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">clc</span>
<span class="nl">.loop:</span>
    <span class="nf">rcr</span>      <span class="no">byte</span> <span class="p">[</span><span class="no">rsi</span><span class="p">],</span><span class="mi">1</span>
    <span class="nf">inc</span>      <span class="no">rsi</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>Left-shifts by one an entire buffer at <code>rsi</code> with a length of <code>rcx</code> bytes. This can also be interpreted as left-shifting by one, i.e. dividing by two, an <strong>arbitrarily long</strong> big-endian <code>8*rcx</code>-bit integer at <code>rsi</code>.</p>
<h3 id="snippet-0x29">Snippet 0x29</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">lea</span>      <span class="no">rdi</span><span class="p">,[</span><span class="no">rsi</span> <span class="err">+</span> <span class="mi">3</span><span class="p">]</span>
    <span class="na">rep</span> <span class="nf">movsb</span>
</pre></div>


<p>Repeats the first 3 bytes at <code>rsi</code> starting from offset <code>rsi+3</code> until <code>rcx</code> bytes have been written.</p>
<p>This could be used to fill a texture of 24-bit pixels with a constant color stored in the first pixel of the buffer. In this case, the first 3 bytes would be written, and then the snippet would be executed with <code>rcx := 3 * width * height - 3</code>.</p>
<h3 id="snippet-0x2a">Snippet 0x2A</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">mov</span>      <span class="no">rdi</span><span class="p">,</span><span class="no">rbx</span>
<span class="nl">.loop:</span>
    <span class="nf">lodsq</span>
    <span class="nf">xchg</span>     <span class="no">rax</span><span class="p">,</span><span class="no">qword</span> <span class="p">[</span><span class="no">rbx</span><span class="p">]</span>
    <span class="nf">stosq</span>
    <span class="nf">loop</span>     <span class="no">.loop</span>
</pre></div>


<p>This moves the last element of the array of <code>rcx</code> keywords pointed by <code>rbx</code> to the front.</p>
<p>For instance, let <code>rcx :=  4</code> and <code>rbx</code> point to <em>[Q0, Q1, Q2, Q3, Q4]</em> with quadwords <em>Qi</em>. Then, after executing this snippet the contents of <code>rbx</code> will be: <em>[Q4, Q0, Q1, Q2, Q3]</em>.</p>
<h3 id="snippet-0x2b">Snippet 0x2B</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">xor</span>      <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">xor</span>      <span class="no">edx</span><span class="p">,</span><span class="no">edx</span>
<span class="nl">.loop1:</span>
    <span class="nf">xlatb</span>
    <span class="nf">xchg</span>     <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">xlatb</span>
    <span class="nf">xlatb</span>
    <span class="nf">xchg</span>     <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">cmp</span>      <span class="no">al</span><span class="p">,</span><span class="no">dl</span>
    <span class="nf">jnz</span>      <span class="no">.loop1</span>

    <span class="nf">xor</span>      <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
<span class="nl">.loop2:</span>
    <span class="nf">xlatb</span>
    <span class="nf">xchg</span>     <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">xlatb</span>
    <span class="nf">xchg</span>     <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">cmp</span>      <span class="no">al</span><span class="p">,</span><span class="no">dl</span>
    <span class="nf">jnz</span>      <span class="no">.loop2</span>
</pre></div>


<p>This snippet expects <code>rbx</code> pointing to a table of 256 <code>uint8_t</code> entries, each containing an index to the next element thus forming a linked list. The first loop can be represented by the following expression:</p>
<div class="codehilite"><pre><span></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="n">rbx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rbx</span><span class="p">[</span><span class="n">rbx</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="p">{</span>
  <span class="n">i</span> <span class="o">=</span> <span class="n">rbx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>


<p>This will traverse the linked list and find the first entry pointing to itself. Obviously, this relies in the assumption that no table entry points to an index occurring previously in the chain as this would result in an endless loop (similar to cycles in linked lists). To prevent this scenario, this table pointed by <code>rbx</code> should have been initialized by <code>rbx[i] = i</code> for <em>i</em> in <em>[0, 255]</em>. The second loop can be represented by the following expression:</p>
<div class="codehilite"><pre><span></span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">while</span> <span class="p">(</span><span class="n">rbx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rbx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
  <span class="n">j</span> <span class="o">=</span> <span class="n">rbx</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>


<p>Since <code>i == rbx[i]</code>, this loop will necessarily terminate and the linked list will be traversed again until the last element is reached. </p>
<h3 id="snippet-0x2c">Snippet 0x2C</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">qword</span> <span class="p">[</span><span class="no">rbx</span> <span class="err">+</span> <span class="mi">8</span><span class="p">*</span><span class="no">rcx</span><span class="p">],</span><span class="mi">0</span>
    <span class="nf">mov</span>      <span class="no">qword</span> <span class="p">[</span><span class="no">rbx</span> <span class="err">+</span> <span class="mi">8</span><span class="p">*</span><span class="no">rdx</span><span class="p">],</span><span class="mi">1</span>
    <span class="nf">mov</span>      <span class="no">rax</span><span class="p">,</span><span class="no">qword</span> <span class="p">[</span><span class="no">rbx</span> <span class="err">+</span> <span class="mi">8</span><span class="p">*</span><span class="no">rcx</span><span class="p">]</span>

    <span class="nf">mov</span>      <span class="no">qword</span> <span class="p">[</span><span class="no">rbx</span><span class="p">],</span><span class="no">rsi</span>
    <span class="nf">mov</span>      <span class="no">qword</span> <span class="p">[</span><span class="no">rbx</span> <span class="err">+</span> <span class="mi">8</span><span class="p">],</span><span class="no">rdi</span>
    <span class="nf">mov</span>      <span class="no">rax</span><span class="p">,</span><span class="no">qword</span> <span class="p">[</span><span class="no">rbx</span> <span class="err">+</span> <span class="mi">8</span><span class="p">*</span><span class="no">rax</span><span class="p">]</span>
</pre></div>


<p>This will move <code>rsi</code> or <code>rdi</code> into <code>rax</code> depending on whether <code>rcx</code> and <code>rdx</code> are different or not, respectively. This is equivalent to: <code>rax := (rcx == rdx) ? rdi : rsi</code>. This assumes that all <code>rbx</code>-relative offsets point to valid memory.</p>
<h3 id="snippet-0x2d">Snippet 0x2D</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">dec</span>      <span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Determines if <code>rax</code> is a power of two by computing <code>rax := rax &amp; (rax - 1)</code>. The result will be zero if and only if <code>rax</code> is a power of two.</p>
<h3 id="snippet-0x2e">Snippet 0x2E</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">dec</span>      <span class="no">rdx</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">cmp</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Determines if <code>rax</code> is a power of two larger than zero by comparing <code>(rax ^ (rax - 1)) &gt;&gt; 1</code> and <code>rax - 1</code>. Both values will be equal if and only if <code>rax</code> is a power of two larger than zero. Note that the case <code>rax == 0</code> will result on different values due to the right-shift operation.</p>
<p>See also: Snippet 0x2D.</p>
<h3 id="snippet-0x2f">Snippet 0x2F</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">xor</span>      <span class="no">eax</span><span class="p">,</span><span class="no">eax</span>
<span class="nl">.loop:</span>
    <span class="nf">jrcxz</span>    <span class="no">.exit_loop</span>
    <span class="nf">inc</span>      <span class="no">rax</span>
    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">dec</span>      <span class="no">rdx</span>
    <span class="nf">and</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">jmp</span>      <span class="no">.loop</span>
<span class="nl">.exit_loop:</span>
</pre></div>


<p>This snippet stores the number of <code>1</code>-bits in <code>rcx</code> into the <code>rax</code> register. This relies on the trick features in <em>Snippet 0x2D</em> to clear the rightmost <code>1</code>-bit until <code>rcx</code> is zero.</p>
<p>See also: Snippet 0x2D.</p>
<h3 id="snippet-0x30">Snippet 0x30</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">sub</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">dec</span>      <span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>This snippet computes <code>((((rax &amp; rdx) - rdx) &amp; rdx) - 1) &amp; rdx</code>. This expression is equivalent to <code>rax &amp; rdx</code>.</p>
<h3 id="snippet-0x31">Snippet 0x31</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">xor</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">inc</span>      <span class="no">rax</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">xor</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">xor</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rcx</span>
</pre></div>


<p>Finds the highest power of two dividing <code>rax + 1</code> by computing: <code>((rax &gt;&gt; 1) ^ rax) ^ (((rax + 1) &gt;&gt; 1) ^ (rax + 1))</code>. This corresponds to the sequence: <a href="https://oeis.org/A006519">A006519</a> as <code>rax</code> increases. The first terms are: 1, 2, 1, 4, 1, 2, 1, 8, 1, 2, 1, 4, ...</p>
<h3 id="snippet-0x32">Snippet 0x32</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">popcnt</span>   <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">1</span>
</pre></div>


<p>This computes <code>rax := (popcnt((rax &gt;&gt; 1) ^ rax) ^ rax) &amp; 1</code> where <em>popcnt</em> computes the number of <code>1</code>-bits. This evaluates to <code>0</code> for all inital values of <code>rax</code>.</p>
<h3 id="snippet-0x33">Snippet 0x33</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x1</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x2</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x4</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x8</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x10</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x20</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Defines a permutation of 64-bit integers where each <code>rax</code> value is mapped into the corresponding 64-bit Grey-code. This corresponds to the sequence <a href="https://oeis.org/A006068">A006068</a> and it's computed via:</p>
<div class="codehilite"><pre><span></span><span class="nl">rax</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&gt;&gt;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">^</span> <span class="n">rax</span>
<span class="nl">rax</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&gt;&gt;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">^</span> <span class="n">rax</span>
<span class="nl">rax</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&gt;&gt;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">^</span> <span class="n">rax</span>
<span class="nl">rax</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&gt;&gt;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">^</span> <span class="n">rax</span>
<span class="nl">rax</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&gt;&gt;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">^</span> <span class="n">rax</span>
<span class="nl">rax</span> <span class="p">:</span><span class="o">=</span> <span class="p">(</span><span class="n">rax</span> <span class="o">&gt;&gt;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">^</span> <span class="n">rax</span>
</pre></div>


<p>See also: https://en.wikipedia.org/wiki/Gray_code</p>
<h3 id="snippet-0x34">Snippet 0x34</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0xffff0000</span>
    <span class="nf">shr</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0x10</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x0000ffff</span>
    <span class="nf">shl</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x10</span>
    <span class="nf">or</span>       <span class="no">eax</span><span class="p">,</span><span class="no">ecx</span>

    <span class="nf">mov</span>      <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0xff00ff00</span>
    <span class="nf">shr</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0x8</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x00ff00ff</span>
    <span class="nf">shl</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x8</span>
    <span class="nf">or</span>       <span class="no">eax</span><span class="p">,</span><span class="no">ecx</span>

    <span class="nf">mov</span>      <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0xcccccccc</span>
    <span class="nf">shr</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0x2</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x33333333</span>
    <span class="nf">shl</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x2</span>
    <span class="nf">or</span>       <span class="no">eax</span><span class="p">,</span><span class="no">ecx</span>

    <span class="nf">mov</span>      <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0xf0f0f0f0</span>
    <span class="nf">shr</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0x4</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x0f0f0f0f</span>
    <span class="nf">shl</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x4</span>
    <span class="nf">or</span>       <span class="no">eax</span><span class="p">,</span><span class="no">ecx</span>

    <span class="nf">mov</span>      <span class="no">ecx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0xaaaaaaaa</span>
    <span class="nf">shr</span>      <span class="no">ecx</span><span class="p">,</span><span class="mi">0x1</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x55555555</span>
    <span class="nf">shl</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x1</span>
    <span class="nf">or</span>       <span class="no">eax</span><span class="p">,</span><span class="no">ecx</span>
</pre></div>


<p>The snippet is made of five blocks, each aggregating and adding pairs of consecutive ranges of adjacent bits from the <code>rax</code> register. The size of this ranges in each block are respectively: 1, 2, 4, 8 and 16 bits.</p>
<h3 id="snippet-0x35">Snippet 0x35</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">edx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x55555555</span>
    <span class="nf">shr</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x1</span>
    <span class="nf">and</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x55555555</span>
    <span class="nf">add</span>      <span class="no">eax</span><span class="p">,</span><span class="no">edx</span>

    <span class="nf">mov</span>      <span class="no">edx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x33333333</span>
    <span class="nf">shr</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x2</span>
    <span class="nf">and</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x33333333</span>
    <span class="nf">add</span>      <span class="no">eax</span><span class="p">,</span><span class="no">edx</span>

    <span class="nf">mov</span>      <span class="no">edx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x0f0f0f0f</span>
    <span class="nf">shr</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x4</span>
    <span class="nf">and</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x0f0f0f0f</span>
    <span class="nf">add</span>      <span class="no">eax</span><span class="p">,</span><span class="no">edx</span>

    <span class="nf">mov</span>      <span class="no">edx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x00ff00ff</span>
    <span class="nf">shr</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x8</span>
    <span class="nf">and</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x00ff00ff</span>
    <span class="nf">add</span>      <span class="no">eax</span><span class="p">,</span><span class="no">edx</span>

    <span class="nf">mov</span>      <span class="no">edx</span><span class="p">,</span><span class="no">eax</span>
    <span class="nf">and</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">0x0000ffff</span>
    <span class="nf">shr</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x10</span>
    <span class="nf">and</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0x0000ffff</span>
    <span class="nf">add</span>      <span class="no">eax</span><span class="p">,</span><span class="no">edx</span>
</pre></div>


<p>The snippet is made of five blocks, each aggregating and adding pairs of consecutive ranges of adjacent bits from the <code>rax</code> register. The size of this ranges in each block are respectively: 1, 2, 4, 8 and 16 bits.</p>
<p>See also: Snippet 0x34.</p>
<h3 id="snippet-0x36">Snippet 0x36</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">dec</span>      <span class="no">rax</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x1</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x2</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x4</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x8</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x10</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x20</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">inc</span>      <span class="no">rax</span>
</pre></div>


<p>Maps positive values in <code>rax</code> to their next power of two, or itself if already a power of two. Non-positive values get mapped to 0.</p>
<p>This works by decreasing the number and replicating the most-significant non-zero bits to all their relatively least-significant bits, resulting in a value of the form <em>2^N - 1</em>. Finally, the number is incremented to obtain the desired power of two.</p>
<h3 id="snippet-0x37">Snippet 0x37</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">not</span>      <span class="no">rdx</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0x8080808080808080</span>
    <span class="nf">and</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0x0101010101010101</span>
    <span class="nf">sub</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>The goal seems to be replacing each byte in the <code>rax</code> register with 0x00 if non-zero, or with 0x80 if zero. For instance:</p>
<div class="codehilite"><pre><span></span>0102030400000000 =&gt; 8080808000000000
0500060007000800 =&gt; 8000800080008000
0000FFFE00000102 =&gt; 0000808000008080
...
</pre></div>


<p>However, 0x01 bytes followed exclusively by 0x00 or 0x01 bytes to their right are an exception and will be replaced with 0x80 as well, since substracting both the carried bit and the 0x01 byte will turn them into a negative byte. For instance:</p>
<div class="codehilite"><pre><span></span>0100000000000000 =&gt; 8080808080808080
0101000000000000 =&gt; 8080808080808080
FF01010000000000 =&gt; 0080808080808080
...
</pre></div>


<p><em>TODO: It's not clear whether this is a bug, or a feature.</em></p>
<h3 id="snippet-0x38">Snippet 0x38</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">bsf</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">dec</span>      <span class="no">rdx</span>
    <span class="nf">or</span>       <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>

    <span class="nf">mov</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">inc</span>      <span class="no">rax</span>

    <span class="nf">mov</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">not</span>      <span class="no">rbx</span>
    <span class="nf">inc</span>      <span class="no">rdx</span>
    <span class="nf">and</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">dec</span>      <span class="no">rdx</span>

    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">cl</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">1</span>

    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p><em>TODO: No idea about this one.</em></p>
<h3 id="snippet-0x39">Snippet 0x39</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0xaaaaaaaaaaaaaaaa</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
</pre></div>


<p>Computes the negabinary representation of <code>rax</code>.</p>
<p>Instead of having the binary basis <em>(+1, +2, +4, +8, +16, +32, ...)</em>, negabinary numbers have the basis <em>(+1, -2, +4, -8, +16, -32, ...)</em>. For instance, the number <em>3</em> (i.e. 0b11) gets mapped into 0b111 (i.e. 7) since <em>3 = 4 - 2 + 1</em>.</p>
<h3 id="snippet-0x3a">Snippet 0x3A</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">neg</span>      <span class="no">rdx</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">0x218a392cd3d5dbf</span>
    <span class="nf">mul</span>      <span class="no">rdx</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">0x3a</span>

    <span class="nf">xlatb</span>
</pre></div>


<p>This snippet computes the amount of (left-most) leading zeros via De Bruijn sequences.</p>
<p>The first block determines the highest power of two dividing <code>rax</code> by computing <code>rax := rax &amp; (-rax)</code>. This results in the sequence <a href="https://oeis.org/A006519">A006519</a> whose first elements are: 0, 1, 2, 1, 4, 1, 2, 1, 8, ...</p>
<p>The second block together with the <code>xlatb</code> instruction computes <code>rax := rbx[(rax * 218A392CD3D5DBF) &gt;&gt; 58]</code> where <code>rbx</code> points to a De Bruijn table with 64 entries. This is equivalent to computing the binary logarithm of the previous 64-bit integer.</p>
<p>See also: http://supertech.csail.mit.edu/papers/debruijn.pdf</p>
<h3 id="snippet-0x3b">Snippet 0x3B</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">cdq</span>
    <span class="nf">shl</span>      <span class="no">eax</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">and</span>      <span class="no">edx</span><span class="p">,</span><span class="mi">0xc0000401</span>
    <span class="nf">xor</span>      <span class="no">eax</span><span class="p">,</span><span class="no">edx</span>
</pre></div>


<p>This snippet computes:</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">eax</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">eax</span> <span class="o">=</span> <span class="p">(</span><span class="n">eax</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">else</span>
    <span class="n">eax</span> <span class="o">=</span> <span class="p">(</span><span class="n">eax</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xC0000401</span>
</pre></div>


<p><em>TODO: Is there anything else special about this snippet?</em></p>
<h3 id="snippet-0x3c">Snippet 0x3C</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0xaaaaaaaaaaaaaaaa</span>
    <span class="nf">and</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">shr</span>      <span class="no">rbx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">and</span>      <span class="no">rbx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">popcnt</span>   <span class="no">rbx</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">and</span>      <span class="no">rbx</span><span class="p">,</span><span class="mi">1</span>

    <span class="nf">neg</span>      <span class="no">rax</span>
    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">0xaaaaaaaaaaaaaaaa</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">shr</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">popcnt</span>   <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">1</span>

    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">add</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">dec</span>      <span class="no">rax</span>
    <span class="nf">neg</span>      <span class="no">rax</span>
    <span class="nf">sub</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rbx</span>
</pre></div>


<p><em>TODO: No idea about this one.</em></p>
<h3 id="snippet-0x3d">Snippet 0x3D</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">1</span>
<span class="nl">.loop:</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">not</span>      <span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">not</span>      <span class="no">rax</span>

    <span class="nf">xor</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">not</span>      <span class="no">rdx</span>
    <span class="nf">and</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rdx</span>
    <span class="nf">not</span>      <span class="no">rdx</span>

    <span class="nf">shl</span>      <span class="no">rcx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">jnz</span>      <span class="no">.loop</span>
</pre></div>


<p><em>TODO: No idea about this one.</em></p>
<h3 id="snippet-0x3e">Snippet 0x3E</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">shr</span>      <span class="no">rdx</span><span class="p">,</span><span class="mi">1</span>
    <span class="nf">xor</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">popcnt</span>   <span class="no">rax</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="mi">0x3</span>
</pre></div>


<p>Computes the direction of the lines in the (Heighway) Dragon Curve by computing <code>popcnt(rax ^ (rax &gt;&gt; 1)) &amp; 3</code>. This produces the sequence <a href="https://oeis.org/A246960">A246960</a>, the fixed point of the morphism <em>{0 -&gt; (0,1), 1 -&gt; (2,1), 2 -&gt; (2,3), 3 -&gt; (0,3)}</em>.</p>
<h3 id="snippet-0x3f">Snippet 0x3F</h3>
<div class="codehilite"><pre><span></span>    <span class="nf">mov</span>      <span class="no">rbx</span><span class="p">,</span><span class="mi">3</span>
    <span class="nf">mov</span>      <span class="no">r8</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">mov</span>      <span class="no">rcx</span><span class="p">,</span><span class="no">rax</span>
    <span class="nf">dec</span>      <span class="no">rcx</span>

    <span class="nf">and</span>      <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">xor</span>      <span class="no">edx</span><span class="p">,</span><span class="no">edx</span>
    <span class="nf">div</span>      <span class="no">rbx</span>
    <span class="nf">mov</span>      <span class="no">rsi</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">mov</span>      <span class="no">rax</span><span class="p">,</span><span class="no">r8</span>
    <span class="nf">or</span>       <span class="no">rax</span><span class="p">,</span><span class="no">rcx</span>
    <span class="nf">xor</span>      <span class="no">edx</span><span class="p">,</span><span class="no">edx</span>
    <span class="nf">div</span>      <span class="no">rbx</span>
    <span class="nf">inc</span>      <span class="no">rdx</span>
    <span class="nf">cmp</span>      <span class="no">rdx</span><span class="p">,</span><span class="no">rbx</span>
    <span class="nf">sbb</span>      <span class="no">rdi</span><span class="p">,</span><span class="no">rdi</span>
    <span class="nf">and</span>      <span class="no">rdi</span><span class="p">,</span><span class="no">rdx</span>

    <span class="nf">bsf</span>      <span class="no">rax</span><span class="p">,</span><span class="no">r8</span>
</pre></div>


<p>This snippet computes:</p>
<div class="codehilite"><pre><span></span>rsi = ((rax &amp; (rax - 1)) % 3)
rdx = ((rax | (rax - 1)) % 3) + 1
rdi = (rdx == 3) ? 0 : rdx;
rax = bsf(rax)
</pre></div>


<p><em>TODO: No idea about this one.</em></p>
        </article>
        <hr>
        <footer>
            <p>
                Questions? Comments? <a href="https://github.com/AlexAltea/blog/issues">Open an issue!</a>
            </p>
            <p><a href="mailto:alexandro@phi.nz">alexandro@phi.nz</a></p>
        </footer>
    </body>
</html>
